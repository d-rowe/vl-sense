function addNote(a,b){var c=yToNote(b);pushNote(c,a),a>score.notes.length-1&&(a=score.notes.length-1),sortVoices(c.clef,a),sortChord(a);[vexVoices.soprano,vexVoices.alto,vexVoices.tenor,vexVoices.bass];reloadscore()}function deleteScore(){ctx.paper.clear()}function clearScore(){deleteScore(),resetScore()}function createHoverNote(a,b){""!=hoverNote&&hoverNote.remove(),hoverNote=ctx.paper.ellipse(a,b,6,5).attr({fill:"#2E343D",stroke:"#2E343D"}).transform("r335")}function drawStaves(){var a=$("#scorediv").width();topStaff=new Vex.Flow.Stave(20,5,a/score.zoom-50),bottomStaff=new Vex.Flow.Stave(20,115,a/score.zoom-50),topStaff.addClef("treble"),bottomStaff.addClef("bass"),topStaff.addKeySignature(score.key),bottomStaff.addKeySignature(score.key),score.start_x=topStaff.start_x*score.zoom;var b=new Vex.Flow.StaveConnector(topStaff,bottomStaff).setType(3),c=new Vex.Flow.StaveConnector(topStaff,bottomStaff).setType(1),d=new Vex.Flow.StaveConnector(topStaff,bottomStaff).setType(7);b.setContext(ctx).draw(),c.setContext(ctx).draw(),d.setContext(ctx).draw(),topStaff.setContext(ctx).draw(),bottomStaff.setContext(ctx).draw(),score.idLength=Math.floor(($("#scorediv").width()-50-score.start_x)/score.notegap),repositionNumerals()}function drawVoices(){function a(){return new Vex.Flow.Voice({num_beats:vexVoices.soprano.length,beat_value:4,resolution:Vex.Flow.RESOLUTION})}var b=a().addTickables(vexVoices.soprano),c=a().addTickables(vexVoices.alto),d=a().addTickables(vexVoices.tenor),e=a().addTickables(vexVoices.bass),f=new Vex.Flow.Formatter;f.format([b,c,d,e],score.notegap/score.zoom*score.notes.length);var g=Math.max(topStaff.getNoteStartX(),bottomStaff.getNoteStartX());topStaff.setNoteStartX(g),bottomStaff.setNoteStartX(g),b.draw(ctx,topStaff),c.draw(ctx,topStaff),d.draw(ctx,bottomStaff),e.draw(ctx,bottomStaff)}function applyAccidentalToChr(a){if("n"==nextAccidental)var b=a;else var b=a+nextAccidental;return nextAccidental="",$("#flat").removeClass("accpressed"),$("#sharp").removeClass("accpressed"),$("#natural").removeClass("accpressed"),b}function getNote(a,b){return score.notes[a][b].scientific()}function getChord(a){for(var b=[],c=0;c<score.notes[a].length;c++)b.push(score.notes[a][c].scientific());return b}function getPos(a){var b=a.match(/\d+/)[0],c={C:0,D:2,E:4,F:5,G:7,A:9,B:11},d=c[a[0]];return d+=12*b,"b"==a[1]?d-=1:"#"==a[1]&&(d+=1),d}function getAccidentals(){var a="",b="M";-1!=$.inArray("m",score.key)&&(b="m"),"b"==score.key[1]?a="b":"#"==score.key[1]&&(a="#");var c=score.key[0]+a;if("M"==b){var d=["F","Bb","Eb","Ab","Db","Gb","Cb"],e=["G","D","A","E","B","F#","C#"];if(-1!=$.inArray(c,d)){var f=["Bb","Eb","Ab","Db","Gb","Cb","Fb"];return f.slice(0,$.inArray(c,d)+1)}if(-1!=$.inArray(c,e)){var g=["F#","C#","G#","D#","A#","E#","B#"];return g.slice(0,$.inArray(c,e)+1)}}else{var h=["D","G","C","F","Bb","Eb","Ab"],i=["E","B","F#","C#","G#","D#","A#"];if(-1!=$.inArray(c,h)){var f=["Bb","Eb","Ab","Db","Gb","Cb","Fb"];return f.slice(0,$.inArray(c,h)+1)}if(-1!=$.inArray(c,i)){var g=["F#","C#","G#","D#","A#","E#","B#"];return g.slice(0,$.inArray(c,i)+1)}}}function applyKeySigToChr(a){return fchr=a+"b",schr=a+"#",-1!=$.inArray(fchr,score.keyAccidentals)?a+"b":-1!=$.inArray(schr,score.keyAccidentals)?a+"#":a}function pushNote(a,b){var b=Math.abs(b),c=a.clef;b>score.notes.length-1?(score.notes.push([a]),"treble"==c?(vexVoices.soprano.push(createStaveNote(a,1)),lastaddednote=vexVoices.soprano[b],fillGhost()):(vexVoices.bass.push(createStaveNote(a,-1)),lastaddednote=vexVoices.bass[b],fillGhost())):"treble"==c?"yes"==vexVoices.soprano[b].ghost?(score.notes[b].push(a),vexVoices.soprano[b]=createStaveNote(a,1),lastaddednote=vexVoices.soprano[b],fillGhost()):"yes"==vexVoices.alto[b].ghost?(score.notes[b].push(a),vexVoices.alto[b]=createStaveNote(a,-1),lastaddednote=vexVoices.alto[b],fillGhost()):replaceNote(b,a.y):"yes"==vexVoices.bass[b].ghost?(score.notes[b].push(a),vexVoices.bass[b]=createStaveNote(a,-1),lastaddednote=vexVoices.bass[b],fillGhost()):"yes"==vexVoices.tenor[b].ghost?(score.notes[b].push(a),vexVoices.tenor[b]=createStaveNote(a,1),lastaddednote=vexVoices.tenor[b],fillGhost()):replaceNote(b,a.y),reloadscore(),playNote(a)}function createStaveNote(a,b){function c(){"b"==e[1]?"b"==e[2]?f.addAccidental(0,new Vex.Flow.Accidental("bb")):f.addAccidental(0,new Vex.Flow.Accidental("b")):"#"==e[1]?"#"==e[2]?f.addAccidental(0,new Vex.Flow.Accidental("##")):f.addAccidental(0,new Vex.Flow.Accidental("#")):f.addAccidental(0,new Vex.Flow.Accidental("n"))}var d=a.vexnote,e=a.scientific(),f=new Vex.Flow.StaveNote({keys:[d],duration:"q",stem_direction:b});return f.ghost="no",""!=a.accidental()?-1==$.inArray(e[0]+e[1],score.keyAccidentals)&&c():-1!=$.inArray(e[0]+"b",score.keyAccidentals)?c():-1!=$.inArray(e[0]+"#",score.keyAccidentals)&&c(),f}function createGhostNote(){var a=new Vex.Flow.GhostNote({keys:["C/4"],duration:"q"});return a.ghost="yes",a}function fillGhost(){for(var a=[vexVoices.soprano,vexVoices.alto,vexVoices.tenor,vexVoices.bass],b=0,c=0;3>=c;c++)a[c].length>b&&(b=a[c].length);for(var c=0;3>=c;c++)for(;a[c].length<b;)a[c].push(createGhostNote())}function replaceNote(a,b){for(var c=yToNote(b),d=[],e=99,f=0;f<score.notes[a].length;f++){var g=Math.abs(b-score.notes[a][f].ypos);e>g&&(e=g,d=f)}score.notes[a][d]=yToNote(b),sortChord(a),idToVoice(a,d,c)}function idToVoice(a,b,c){for(var d,e=score.notes[a][b].clef,f=0;f<score.notes[a].length;f++)score.notes[a][f].clef==e&&f!=b&&(d=f);score.notes[a][b].key()>score.notes[a][d].key()?"treble"==e?vexVoices.soprano[a]=createStaveNote(c,1):vexVoices.tenor[a]=createStaveNote(c,1):"treble"==e?vexVoices.alto[a]=createStaveNote(c,-1):vexVoices.bass[a]=createStaveNote(c,-1)}function sortStave(a,b){a[b].length>1&&getPos(a[b][0])>getPos(a[b][1])&&a[b].reverse()}function sortVoices(a,b){if("treble"==a){if("no"==vexVoices.alto[b].ghost){var c=vexVoices.soprano[b],d=vexVoices.alto[b];getPos(d.keys[0])>getPos(c.keys[0])&&(vexVoices.soprano[b]=d.setStemDirection(1),vexVoices.alto[b]=c.setStemDirection(-1))}}else if("no"==vexVoices.tenor[b].ghost){var e=vexVoices.tenor[b],f=vexVoices.bass[b];getPos(f.keys[0])>getPos(e.keys[0])&&(vexVoices.tenor[b]=f.setStemDirection(1),vexVoices.bass[b]=e.setStemDirection(-1))}}function sortChord(a){void 0!==score.notes[a]&&score.notes[a].sort(function(a,b){return a.key()>b.key()?1:a.key()<b.key()?-1:0})}function yToNote(a){var b=-2,c=-3;if(a>15)var d="treble",e=a-b;else var d="bass",e=a-c;var f=String.fromCharCode(65+e%7),g=Math.round((e+2)/7);if("bass"==d){g+=3,nchr=String.fromCharCode(65+(e+2)%7),noct=Math.round((e+4)/7)+1,""==nextAccidental?nchr=applyKeySigToChr(nchr):nchr=applyAccidentalToChr(nchr);var h=teoria.note(nchr+noct)}else{f=""==nextAccidental?applyKeySigToChr(f):applyAccidentalToChr(f);var h=teoria.note(f+g)}var i=f+"/"+g;return h.y=a,h.clef=d,h.vexnote=i,h.ypos=a,h}function correctNumeral(a){function b(){for(var b,c=["i","I","v","V"],d="",e=0;e<a.length;e++){var f=a[e];-1!=$.inArray(f,c)&&(""==d&&(b=f==f.toUpperCase()?"Upper":"Lower"),d+="Upper"==b?a[e].toUpperCase():a[e].toLowerCase())}return d}function c(){for(var b=["6","4"],c=["6","64","65","43","42"],e="",f=d.length;f<a.length;f++){var g=a[f];if(f!=d.length)return-1!=$.inArray(e+g,c)?e+g:"4"==e?"":e;if(-1==$.inArray(g,b))return"";if(e=g,f==a.length-1)return"6"==e?e:""}return""}var d=b();return d+c()}function initNumerals(){for(var a=0;a<score.idLength;a++){var b=score.notegap*a+score.start_x;b+="px",$("#keyrns").append("<input type='text' class='numeral' maxlength='7'></input>"),$(".numeral").last().css("left",b)}watchNumerals()}function repositionNumerals(){var a=$(".numeral").length,b=score.idLength;if(a!=b){for(;a>b;)$(".numeral").last().remove(),a=$(".numeral").length;for(;b>a;)$("#keyrns").append("<input type='text' class='numeral' maxlength='7'></input>"),a=$(".numeral").length}for(var c=0;c<$(".numeral").length;c++){var d=score.notegap*c+score.start_x;d+="px",$(".numeral").eq(c).css("left",d)}}function watchNumerals(){$(".numeral").change(function(){var a=$(this).val(),b=correctNumeral(a);$(this).val(b)})}function playNote(a){var a=a.midi(),b=127,c=0;MIDI.setVolume(0,127),MIDI.noteOn(0,a,b,c),MIDI.noteOff(0,a,c+.75)}function playChord(a){for(var b=[],c=0;c<score.notes[a].length;c++)b.push(score.notes[a][c].midi());MIDI.chordOn(0,b,127,0)}function stopChord(a){for(var b=[],c=0;c<score.notes[a].length;c++)b.push(score.notes[a][c].midi());MIDI.chordOff(0,b,getSecs())}function playScore(){playChord(0),stopChord(0);for(var a=1;a<score.notes.length;a++)playDelayedChord(a)}function playDelayedChord(a){setTimeout(function(){playChord(a),stopChord(a)},getMills()*a)}function getSecs(){return 60/score.tempo}function getMills(){return 60/score.tempo*1e3}function drawPlaceHolder(){ctx.rect(score.start_x-5,10,20,210,10)}function flash(a,b){var c=$(a).css("background-color");$(a).animate({backgroundColor:jQuery.Color(b)},50).animate({backgroundColor:jQuery.Color(c)},750)}function resetScore(){scorediv=$("div")[2],renderer=new Vex.Flow.Renderer(scorediv,Vex.Flow.Renderer.Backends.RAPHAEL),ctx=renderer.getContext(),$("#key").val("CM:"),score={key:"C",length:125,start_x:70,zoom:1.25,notegap:60,tempo:60,notes:[],previouskey:"CM:",keyAccidentals:[]},vexVoices={soprano:[],alto:[],tenor:[],bass:[]},nextAccidental="",hoverNote="",lastaddednote="",currentnotecolor="blue",isplaying=!1,ctx.scale(score.zoom,score.zoom),reloadscore(),initNumerals(),loadMIDI()}function loadMIDI(){MIDI.loadPlugin({soundfontUrl:"/static/soundfonts/",instrument:"acoustic_grand_piano"})}function getAccidental(a){if("b"==a[1]||"#"==a[1])var b=a[1];else if("B"==a[1])var b="b";else var b="";return b}function getSonority(a){if(a)var b=key[2];else var b=key[1];return b}function reloadscore(){deleteScore(),drawStaves(),drawVoices()}function resizescore(){deleteScore(),scorediv=$("div")[2],renderer=new Vex.Flow.Renderer(scorediv,Vex.Flow.Renderer.Backends.RAPHAEL),ctx=renderer.getContext(),ctx.scale(score.zoom,score.zoom),reloadscore()}$(document).ready(function(){$("#restart").click(function(){1==confirm("Restarting will delete all of your previous work.  Are you sure you want to do this?")&&clearScore()})}),$(function(){$("#scorediv").mousemove(function(a){var b=35,c=$(this).offset(),d={x:Math.round((a.pageX-c.left-b-score.start_x)/score.notegap+.2),y:a.pageY-c.top-$("#scorediv").height()};d.x>-1&&d.x<score.idLength?(d.y=Math.round(d.y/(5*score.zoom)),d.x=d.x*score.notegap+score.start_x+54,d.y+=40,d.y*=5*score.zoom,createHoverNote(d.x,d.y)):hoverNote.remove()}),$("#scorediv").mouseleave(function(a){""!=hoverNote&&hoverNote.remove()})}),$(function(){$("#natural").click(function(){"n"==nextAccidental?(nextAccidental="",$(this).removeClass("accpressed")):(nextAccidental="n",$(this).addClass("accpressed"),$("#flat").removeClass("accpressed"),$("#sharp").removeClass("accpressed"))}),$("#flat").click(function(){"b"==nextAccidental?(nextAccidental="",$(this).removeClass("accpressed")):(nextAccidental="b",$(this).addClass("accpressed"),$("#natural").removeClass("accpressed"),$("#sharp").removeClass("accpressed"))}),$("#sharp").click(function(){"#"==nextAccidental?(nextAccidental="",$(this).removeClass("accpressed")):(nextAccidental="#",$(this).addClass("accpressed"),$("#flat").removeClass("accpressed"),$("#natural").removeClass("accpressed"))})}),$(document).ready(function(){$("#play").click(function(){score.notes.length>0&&playScore()})}),$(function(){resetScore()}),problemkeys=["B#M","b#m","gbm","A#M"],$(function(){$("#key").on("change",function(){var a=$("#key").val();""==a&&(a=score.previouskey);var b=a[0],c=b.toUpperCase(),d=c.charCodeAt(0),e=getAccidental(a),f=getSonority(e);d>=65&&71>=d||(flash("#key","#FF3D2E"),a=score.previouskey,b=a[0],c=b.toUpperCase(),d=c.charCodeAt(0),e=getAccidental(a),f=getSonority(e)),"M"==f?b=c:"m"==f?b=b.toLowerCase():f=b==b.toLowerCase()?"m":"M";var g=b+e+f+":";if($("#key").val(g),score.previouskey=g,"M"==f)var h=c+e;else var h=c+e+f;score.key=h,reloadscore(),score.keyAccidentals=getAccidentals()})}),$(function(){$("#scorediv").mousedown(function(a){var b=35,c=$(this).offset(),d={x:Math.round((a.pageX-c.left-b-score.start_x)/score.notegap),y:$("#scorediv").height()-(a.pageY-c.top)};d.y=Math.round(d.y/(5*score.zoom)),d.x<score.idLength&&addNote(d.x,d.y)})});var resizeTimer;$(window).resize(function(){resizescore()});